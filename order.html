<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order — Mellow Cheez</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-50">
  <header class="bg-yellow-500 text-white">
    <div class="max-w-6xl mx-auto p-4 flex justify-between">
      <h1 class="text-lg font-bold">Place Order</h1>
      <a href="admin.html" class="bg-white text-yellow-600 px-3 py-1 rounded">Admin</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6 grid lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <h2 class="text-xl font-bold mb-3">Menu</h2>
      <div id="order-menu" class="grid sm:grid-cols-2 gap-4"></div>
    </div>

    <aside class="bg-white p-4 rounded shadow">
      <h3 class="font-bold">Cart</h3>
      <div id="cart-list" class="mt-3 space-y-2"></div>
      <div class="mt-3 font-semibold">Total: Rs <span id="cart-total">0</span></div>

      <hr class="my-3">

      <h3 class="font-bold">Your Details</h3>
      <input id="o_name" placeholder="Name" class="w-full p-2 border rounded my-2">
      <input id="o_phone" placeholder="Phone" class="w-full p-2 border rounded my-2">
      <textarea id="o_address" placeholder="Address (for delivery)" class="w-full p-2 border rounded my-2"></textarea>
      <label class="block mt-2">Order Type</label>
      <select id="o_type" class="w-full p-2 border rounded">
        <option value="Takeaway">Takeaway</option>
        <option value="Delivery">Delivery</option>
        <option value="Dine-In">Dine-In</option>
      </select>

      <button class="mt-4 bg-yellow-500 text-white w-full py-2 rounded" onclick="checkout()">Place Order</button>

      <div id="order-confirm" class="mt-4 hidden">
        <h4 class="font-bold">Order Confirmed</h4>
        <p>Order ID: <span id="ord-id"></span></p>
        <div id="ord-qr" class="my-3"></div>
        <button class="px-3 py-1 border rounded" onclick="printOrderReceipt()">Print / Save PDF</button>
      </div>
    </aside>
  </main>

  <script src="script.js"></script>
  <script>
    window.addEventListener('load', () => {
      renderOrderMenu();
      renderCartUI();
    });

    function addToCart(id){
      addItemToCartById(id);
      renderCartUI();
    }
    function addDealToCart(id){
      addDealToCartById(id);
      renderCartUI();
    }

    function checkout(){
      const name = document.getElementById('o_name').value.trim();
      const phone = document.getElementById('o_phone').value.trim();
      const address = document.getElementById('o_address').value.trim();
      const type = document.getElementById('o_type').value;
      if(!name || !phone){ alert('Please enter name and phone'); return; }
      const cart = getCart();
      if(!cart.length){ alert('Cart is empty'); return; }

      const total = cart.reduce((s,i)=>s + (i.price*i.qty), 0);
      const order = {
        id: generateOrderId(),
        name, phone, address, type,
        items: cart,
        total,
        status: 'Pending',
        timestamp: new Date().toISOString()
      };
      saveOrder(order);
      clearCart();
      renderCartUI();

      // show confirmation with QR
      document.getElementById('order-confirm').classList.remove('hidden');
      document.getElementById('ord-id').innerText = order.id;
      const qrContainer = document.getElementById('ord-qr');
      qrContainer.innerHTML = '';
      const qr = new QRCode(qrContainer, {
        text: JSON.stringify({orderId: order.id, name: order.name, total: order.total}),
        width: 160, height: 160
      });
      // store last printed order id to print later
      localStorage.setItem('last_print_order', order.id);
      alert('Order placed! Order ID: ' + order.id + '. You can print/download the receipt.');
    }

    function printOrderReceipt(){
      const orderId = localStorage.getItem('last_print_order');
      const orders = getOrders();
      const order = orders.find(o => o.id === orderId);
      if(!order){ alert('No recent order to print'); return; }
      // build printable box
      const el = document.createElement('div');
      el.style.padding = '20px';
      el.style.fontFamily = 'Arial, sans-serif';
      el.innerHTML = `<h2>Mellow Cheez — Order Receipt</h2>
                      <div>Order ID: ${order.id}</div>
                      <div>Name: ${order.name}</div>
                      <div>Phone: ${order.phone}</div>
                      <div>Type: ${order.type}</div>
                      <div>Address: ${order.address||'-'}</div>
                      <hr>
                      <div>${order.items.map(it=>`<div>${it.name} x ${it.qty} — Rs ${it.price*it.qty}</div>`).join('')}</div>
                      <hr>
                      <div><strong>Total: Rs ${order.total}</strong></div>`;
      document.body.appendChild(el);
      // convert to PDF or print using html2pdf
      html2pdf().from(el).save(`Order_${order.id}.pdf`).then(()=> el.remove());
    }

  </script>
</body>
</html>
