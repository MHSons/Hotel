<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Add Test Result</title>
<style>body{font-family:Arial,Helvetica,sans-serif;margin:0;background:linear-gradient(135deg,#1e3a8a,#2563eb);min-height:100vh} .container{max-width:900px;margin:40px auto;background:#fff;padding:25px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.2)} select,input{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc} table{width:100%;border-collapse:collapse;margin-top:10px} th,td{padding:8px;border-bottom:1px solid #eee} button{background:#2563eb;color:#fff;padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:12px} .back{text-align:center;margin-top:10px;display:block;color:#2563eb;text-decoration:none}</style>
</head><body><div class="container"><h2 style="text-align:center;color:#1e3a8a">Add Test Result</h2>
<label>Patient</label><select id="patientSelect"></select>
<label>Department</label><select id="departmentSelect" onchange="loadTests()"></select>
<label>Test</label><select id="testSelect" onchange="addTestRow()"></select>
<table id="resultTable"><thead><tr><th>Test Name</th><th>Result</th><th>Unit</th><th>Normal Range</th><th>Indicator</th><th></th></tr></thead><tbody></tbody></table>
<button onclick="saveReport()">Save Report</button><a class="back" href="dashboard.html">← Back to Dashboard</a></div>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script>
const user = JSON.parse(localStorage.getItem('loggedUser')||'null'); if(!user){alert('Please login');window.location='index.html'}
function loadPatients(){ const p=JSON.parse(localStorage.getItem('patients')||'[]'); const sel=document.getElementById('patientSelect'); sel.innerHTML='<option value="">Select Patient</option>'; p.forEach(x=>sel.innerHTML+='<option value="'+x.patient_code+'">'+x.full_name+' ('+x.patient_code+')</option>') }
function loadDepartments(){ const d=JSON.parse(localStorage.getItem('departments')||'[]'); const sel=document.getElementById('departmentSelect'); sel.innerHTML='<option value="">Select Department</option>'; if(d.length===0){['Hematology','Clinical Chemistry','Microbiology','Serology'].forEach(x=>sel.innerHTML+='<option>'+x+'</option>')} else d.forEach(x=>sel.innerHTML+='<option>'+x.name+'</option>') }
function loadTests(){ const dept=document.getElementById('departmentSelect').value; const sel=document.getElementById('testSelect'); sel.innerHTML='<option value="">Select Test</option>'; const tests=JSON.parse(localStorage.getItem('tests')||'[]').filter(t=>t.department===dept); if(tests.length===0){ const defaults=[{name:'Hemoglobin',unit:'g/dL',min:12,max:17,normal:'12-17 g/dL'},{name:'WBC',unit:'/uL',min:4000,max:11000,normal:'4000-11000'}]; defaults.forEach(t=>sel.innerHTML+='<option data-unit="'+t.unit+'" data-min="'+t.min+'" data-max="'+t.max+'" data-normal="'+t.normal+'">'+t.name+'</option>')} else tests.forEach(t=>sel.innerHTML+='<option data-unit="'+t.unit+'" data-min="'+t.min_value+'" data-max="'+t.max_value+'" data-normal="'+t.normal_range_adult+'">'+t.test_name+'</option>') }
function addTestRow(){ const sel=document.getElementById('testSelect'); if(!sel.value) return; const tbody=document.querySelector('#resultTable tbody'); const testName=sel.value; const unit=sel.selectedOptions[0].dataset.unit||''; const min=parseFloat(sel.selectedOptions[0].dataset.min||'0'); const max=parseFloat(sel.selectedOptions[0].dataset.max||'0'); const normal=sel.selectedOptions[0].dataset.normal||''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${testName}</td><td><input type="number" step="any" oninput="updateIndicator(this,${min},${max})"></td><td>${unit}</td><td>${normal}</td><td class="indicator"></td><td><button onclick="this.closest('tr').remove()">❌</button></td>`; tbody.appendChild(tr); }
function updateIndicator(input,min,max){ const v=parseFloat(input.value); const cell=input.closest('tr').querySelector('.indicator'); if(isNaN(v)){cell.innerText='';cell.style.color='black';return} if(v<min){cell.innerText='Low';cell.style.color='red'} else if(v>max){cell.innerText='High';cell.style.color='red'} else {cell.innerText='Normal';cell.style.color='green'} }
function saveReport(){ const patientCode=document.getElementById('patientSelect').value; if(!patientCode){alert('Select patient');return} const patient=JSON.parse(localStorage.getItem('patients')||'[]').find(p=>p.patient_code===patientCode); if(!patient){alert('Patient not found');return} const rows=document.querySelectorAll('#resultTable tbody tr'); if(rows.length===0){alert('Add tests');return} const results=[]; rows.forEach(r=>{ const tds=r.querySelectorAll('td'); results.push({ test:tds[0].innerText, result:tds[1].querySelector('input').value, unit:tds[2].innerText, range:tds[3].innerText, indicator:tds[4].innerText }) }); const report={ id:Date.now(), report_id:'R-'+Date.now(), patient_code:patient.patient_code, patient_name:patient.full_name, results, department:document.getElementById('departmentSelect').value, created_by:user.user, date:new Date().toISOString() }; const reports=JSON.parse(localStorage.getItem('reports')||'[]'); reports.push(report); localStorage.setItem('reports',JSON.stringify(reports)); const logs=JSON.parse(localStorage.getItem('activityLog')||'[]'); logs.push({time:new Date(),text:'Report created for '+patient.full_name}); localStorage.setItem('activityLog',JSON.stringify(logs)); localStorage.setItem('lastReportId',report.report_id); alert('Report saved'); window.location='report.html' }
loadPatients(); loadDepartments();
</script>
<script src="app.js"></script></body></html>
